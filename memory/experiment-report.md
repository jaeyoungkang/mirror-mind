# V3 기억 네트워크 실험 리포트

## 실험 개요

- **목표**: raw JSONL에서 직접 추출한 fact/intention 노드로 기억 네트워크를 구축하고, 자연스러운 기억 활성화를 만드는 최적 구조를 탐색
- **날짜**: 2026-02-25 (세션 23)
- **이전 실험**: v1(threshold 기반, 75개 노드, 실패) → v2(knn+cooccurrence, 220개 노드, IR 최적화) → v3(자연스러움 최적화)

## 1단계: 노드 추출

### 방법
- 22개 세션의 raw JSONL → `extract_text.py`로 대화 텍스트 추출 → 서브에이전트 21개 병렬 투입 (세션19는 파일럿 기존 결과 재사용)
- 추출 규칙: 브로콜리(AI) 1인칭 시점, fact/intention 2타입만, 하나의 content에 하나의 사실/의도

### 결과

| 항목 | 수치 |
|------|------|
| 세션 수 | 22개 (세션1~22) |
| 총 노드 | **954개** |
| fact | 886개 (92.9%) |
| intention | 68개 (7.1%) |
| 세션당 평균 | 43.4개 |
| 최대 | 세션19: 71개 (파일럿) |
| 최소 | 세션6: 21개 |

v2 최대 노드셋(semantic-unit 220개) 대비 **4.3배** 규모.

### 세션별 분포

| 세션 | 노드 수 | fact | intention |
|------|---------|------|-----------|
| 세션1 | 60 | 54 | 6 |
| 세션2 | 41 | 38 | 3 |
| 세션3 | 46 | 44 | 2 |
| 세션4 | 46 | 42 | 4 |
| 세션5 | 30 | 29 | 1 |
| 세션6 | 21 | 20 | 1 |
| 세션7 | 41 | 38 | 3 |
| 세션8 | 39 | 34 | 5 |
| 세션9 | 40 | 38 | 2 |
| 세션10 | 41 | 39 | 2 |
| 세션11 | 37 | 36 | 1 |
| 세션12 | 42 | 41 | 1 |
| 세션13 | 38 | 34 | 4 |
| 세션14 | 63 | 57 | 6 |
| 세션15 | 48 | 46 | 2 |
| 세션16 | 29 | 25 | 4 |
| 세션17 | 40 | 36 | 4 |
| 세션18 | 38 | 35 | 3 |
| 세션19 | 71 | 66 | 5 |
| 세션20 | 50 | 46 | 4 |
| 세션21 | 54 | 51 | 3 |
| 세션22 | 39 | 37 | 2 |

## 2단계: 네트워크 구축

### 방법
- **임베딩**: OpenAI text-embedding-3-small (954개 노드, 배치 100개씩)
- **knn 링크**: 임베딩 코사인 유사도 → 각 노드에서 top-k 이웃 연결. 양방향이면 1.2x boost.
- **cooccurrence 링크**: 같은 세션 내 인접 노드(거리 ≤3) 연결. weight = 1/(1+dist*0.5).
- **fusion**: knn(alpha=0.6) + cooccurrence(0.4) 가중 합산.
- **k값**: 5, 8, 12, 16 (v2 대비 확장)
- **gate 기준**: 1-hop ≤5%, avg_path ≥3.0, giant_ratio ≥70%

### 결과

| 네트워크 | 엣지 수 | 1-hop | avg_path | giant | gate |
|----------|---------|-------|----------|-------|------|
| **knn/k5** | 3,540 | 0.8% | 4.30 | 1.00 | **PASS** |
| **fusion/k5** | 5,896 | 1.4% | 3.36 | 1.00 | **PASS** |
| **knn/k8** | 5,574 | 1.3% | 3.51 | 1.00 | **PASS** |
| **fusion/k8** | 7,833 | 1.8% | 3.01 | 1.00 | **PASS** |
| **knn/k12** | 8,252 | 1.9% | 3.05 | 1.00 | **PASS** |
| cooc/k5 | 2,730 | 0.6% | — | 0.07 | FAIL |
| cooc/k8 | 2,730 | 0.6% | — | 0.07 | FAIL |
| cooc/k12 | 2,730 | 0.6% | — | 0.07 | FAIL |
| fusion/k12 | 10,395 | 2.4% | 2.76 | 1.00 | FAIL |
| knn/k16 | 10,954 | 2.5% | 2.78 | 1.00 | FAIL |
| cooc/k16 | 2,730 | 0.6% | — | 0.07 | FAIL |
| fusion/k16 | 13,013 | 2.9% | 2.60 | 1.00 | FAIL |

**12개 중 5개 gate 통과.**

### v2 대비 변화
- **임베딩 효과**: TF-IDF(v2)에서 giant 0.7~0.8이었던 것이 OpenAI 임베딩으로 전부 1.0. 모든 노드가 하나의 컴포넌트로 연결됨.
- **cooccurrence 단독 실패**: 세션 간 연결이 없어 giant=0.07로 극심한 파편화. v2에서도 단독 사용은 비효율적이었지만, v3에서는 노드가 세션별로 독립적이라 더 심함.
- **k12가 knn의 실질적 상한**: k12에서 avg_path=3.05로 gate 경계. k16부터 과밀(avg_path < 3.0).

## 3단계: 자연스러움 평가

### 방법
- **평가 방식 전환**: v2의 점수표(relevance/coverage/noise/specificity) → v3는 서브에이전트가 실제 대화를 생성하고 자연스러움을 판단
- **시나리오 3개**:
  - S1: "lighthouse 어디까지 했었지?" (넓은 진행상황 질문)
  - S2: "기억 시스템 네트워크 구조 다음 단계 얘기하자" (구체적 이어가기 질문)
  - S3: "mirror-mind 원칙 돌아보자" (넓은 회고 질문)
- **네트워크 7개**: gate 통과 5개 + 혼합 2개 (knn+cooc)
- **평가 기준 4개** (각 1-5점, 총 20점):
  - 관련성: 활성화된 기억이 질문과 관련 있는가
  - 다양성: 여러 시점/맥락의 기억이 섞여 있는가
  - 연상 자연스러움: 사람이라면 이런 것들을 함께 떠올릴 법한가
  - 대화 품질: 이 기억으로 만든 응답이 동료답고 자연스러운가
- **spreading activation**: 쿼리 → 시드 노드 3개(TF-IDF 매칭) → 2-hop 확산(decay=0.5) → 상위 15개 노드

### 결과

| 네트워크 | S1 (진행상황) | S2 (다음단계) | S3 (회고) | **합계** |
|----------|:---:|:---:|:---:|:---:|
| **knn_k12** | **20** | 17 | **19** | **56/60** |
| **knn_k8** | 19 | **19** | 17 | **55/60** |
| knn_k5 | 19 | 17 | 17 | 53/60 |
| fusion_k5 | 17 | **19** | 16 | 52/60 |
| fusion_k8 | 16 | **19** | 16 | 51/60 |
| knn+cooc_k5 | 11 | 16 | 18 | 45/60 |
| knn+cooc_k8 | 11 | 16 | 18 | 45/60 |

### 시나리오별 분석

**S1 (lighthouse 진행상황)** — 넓은 타임라인 질문
- knn_k12(20점)이 압도적 1위. 8개 세션에 걸쳐 균형 있게 분포. 세션10의 "워크스페이스 독립성 원칙"까지 연상하는 것이 가장 자연스러움.
- cooc 혼합(11점)이 최하위. 세션3에 60% 집중, 초기 셋업 기억만 줄줄이 딸려 나옴.

**S2 (기억 시스템 다음 단계)** — 구체적 이어가기 질문
- knn_k8, fusion_k5, fusion_k8 공동 1위(19점). fusion이 knn에서 올라오지 않는 노드 원자성 디테일 클러스터를 끌어올림.
- knn_k12(17점)는 너무 넓게 퍼져서 초점 분산. k=8이 이 유형의 sweet spot.

**S3 (원칙 회고)** — 넓은 회고 질문
- knn_k12(19점) 1위. 메타에이전트 탄생 기억까지 연상하여 "텍스트→시스템 진화" 서사를 만듦.
- cooc 혼합(18점)이 의외로 2위. "계획→문제→전환"이라는 서사 구조가 회고에 적합.

## 핵심 발견

### 1. 질문 유형별 최적 네트워크가 다르다
- **넓은 질문** (진행상황, 회고): knn_k12 — 먼 시점까지 도달
- **구체적 질문** (이어가기): knn_k8 또는 fusion — 적절한 깊이와 초점
- **서사 필요 질문** (회고): cooc 보조가 도움

### 2. cooccurrence의 양면성
- 같은 세션 노드를 묶어서 활성화하므로 "서사"를 만드는 데 강하다 (S3: 18점)
- 하지만 세션 편중이 심해 타임라인 질문에서는 최악 (S1: 11점)
- 단독 사용은 불가 (giant=0.07), 보조적 혼합에만 활용

### 3. k값의 sweet spot
- k=5: 안전하지만 좁음
- **k=8: 가장 안정적** (편차 최소: 19, 19, 17)
- k=12: 넓은 질문에서 강하지만 구체적 질문에서 초점 분산
- k=16: 과밀로 gate 실패

### 4. fusion의 가치
- 임베딩 유사도만으로 올라오지 않는 디테일 노드를 끌어올림
- 추상적 원칙 + 구체적 디테일을 동시에 포착하는 데 효과적
- 다만 넓은 질문에서는 초기 세션에 편중되는 경향

### 5. OpenAI 임베딩의 효과
- v2 TF-IDF 대비 giant_ratio가 0.7~0.8 → 1.0으로 개선
- 한국어 텍스트의 의미적 유사도 포착이 현저히 나아짐

## 실행 전략 제안

**적응적 네트워크 선택(Adaptive Network Selection)**:
1. 쿼리의 질문 유형을 판단 (넓은/구체적/서사적)
2. 유형에 맞는 네트워크에서 활성화:
   - 넓은 질문 → knn_k12
   - 구체적 질문 → knn_k8 (또는 fusion_k5)
   - 서사 필요 → knn_k8 + cooc 보조
3. 또는 가장 안정적인 **knn_k8을 기본값**으로 사용하고, 필요 시 다른 네트워크를 보조적으로 활용

## 최종 확정 (세션 24)

### 채택 구조: knn_k12 단일

- **네트워크**: knn_k12 (956개 노드, 8,252개 엣지)
- **선택 이유**: 안정적인 knn_k8(편차 최소) 대신 개성 있는 knn_k12를 채택. 먼 시점까지 연상이 도달하고 예상 밖의 연결을 만드는 특성이 브로콜리의 기억으로서 더 자연스럽다.
- **적응적 선택 폐기**: 쿼리 유형 분류 → 네트워크 전환 방식은 "검색 엔진"으로의 회귀이므로 채택하지 않는다. 사람의 기억은 하나의 네트워크에서 자연스럽게 떠오른다.

### 규모 대응 규칙

```
기본값: k = 12
검증 시점: 노드 수가 2배가 될 때 (~2000 → ~4000 → ...)
검증 방법: gate 기준 (1-hop ≤5%, avg_path ≥3.0, giant ≥70%)
조정 규칙:
  - gate 통과 → k=12 유지
  - avg_path < 3.0 → k를 내림 (과밀, 연상이 뭉개짐)
  - avg_path > 6.0 → k를 올림 (과소, 연상이 끊김)
```

k값 자체보다 gate 기준이 본질. 노드가 늘어나면 같은 k=12라도 밀도가 달라지므로, gate를 기준으로 k를 재조정한다.

## 파일 구조

```
memory/simulation/v3/
├── extracted_text/          # 21개 세션 텍스트 (extract_text.py 출력)
├── session{1-22}.json       # 세션별 추출 노드
├── pilot_session19.json     # 파일럿 결과 (기존)
├── nodeset_v3.json          # 전체 954개 노드 (ID 부여)
├── embeddings_cache.json    # OpenAI 임베딩 캐시
├── eval_activations.json    # 평가용 활성화 결과 (3시나리오 × 7네트워크)
├── build_networks_v3.py     # 네트워크 구축 스크립트
├── activate.py              # spreading activation 스크립트
├── networks/                # 구축된 네트워크 (graph.json + stats.json)
│   ├── knn__k5/
│   ├── knn__k8/
│   ├── knn__k12/
│   ├── fusion__k5/
│   ├── fusion__k8/
│   ├── cooc__k5/
│   ├── cooc__k8/
│   └── summary.json
└── experiment-report.md     # 이 문서
```
