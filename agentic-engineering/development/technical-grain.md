# 기술적 결 (Technical Grain)

## 결이란?
제품의 본질(UX·도메인·운영)과 기술이 강제하는 세계관(모델·흐름·제약)이 맞물리는 정도.
맞으면 단순해지고, 안 맞으면 우회·땜질·복잡성이 늘어난다.

## 결 판단 기준
1. 도메인이 리소스(명사) 중심인가, 워크플로(동사) 중심인가?
2. UX가 즉시 응답인가, 실행→대기→수정 반복인가?
3. 운영 관측(로그·비용·재시도·롤백)이 가능한가?

## AI 자율성 설계
`agentic-engineering/service-design/ai-service-design-principles.md`의 핵심 전제와 설계 규칙을 따른다.
자율성 5단계와 판단 기준은 해당 문서를 참조한다.

## 아키텍처 원칙: 3-Plane
- **Product Plane** — UX 경험 (진행 표시, 중단, 되돌리기, 부분 재생성, 맥락 누적)
- **Agent Plane** — 정책 집행 (자율성 레벨 강제, 실행 단계 기록, 안전장치)
- **Execution Plane** — 비동기 실행 (재시도, 비용 통제, 관측, 피드백 루프)

## 안전장치 (Agent Plane)
자율성이 높을수록 안전장치가 강해야 한다. 두 계층으로 나뉜다.

### 코드 레벨
- **샌드박싱** — 에이전트 실행은 격리 환경에서. 파일시스템·네트워크 접근을 최소 권한으로 제한
- **권한 분류** — 행위를 위험도별로 분류하고 승인 수준을 달리한다 (읽기=자동, 쓰기=검토, 삭제·배포=명시적 승인)
- **린트·정적 분석 필수** — ESLint, Semgrep, CodeQL 등 린트와 SAST를 CI에 통합한다. 에이전트가 생성한 코드도 사람이 작성한 코드와 동일한 린트 규칙을 통과해야 한다. pre-commit hook으로 커밋 시점에 강제하는 것을 기본으로 한다
- **다중 검증** — 작성 에이전트와 별도의 검토 에이전트를 분리하여 교차 검증

### 비즈니스 레벨
- **승인 워크플로** — 프로덕션 영향이 있는 변경은 사람의 승인을 거친다 (PR 리뷰, CI/CD 게이트)
- **롤백 보장** — 60초 내에 에이전트의 작업을 되돌릴 수 없으면 안전장치가 부족한 것이다
- **비용 상한** — 세션/태스크/일 단위 비용 한도. 무한 루프로 인한 비용 폭주(Denial of Wallet) 방지
- **감사 추적** — 모든 도구 호출, LLM 상호작용, 의사결정 지점을 추적 가능하게 기록

## 지식 공급 (Evidence 확장)
에이전트는 학습 시점의 지식에 한계가 있다. 외부 지식 공급 체계가 필요하다.

- **Context7 MCP** — 9,000개 이상의 라이브러리에 대해 버전별 최신 문서를 제공하는 MCP 서버. 에이전트 개발 환경에 기본 설치한다
- **MCP(Model Context Protocol)** — 외부 데이터·도구·워크플로 연결의 표준 프로토콜. Context7 외에도 필요에 따라 MCP 서버를 추가하여 지식 공급원을 확장한다
- **버전 인식** — 프로젝트 매니페스트(package.json 등)에서 의존성 버전을 읽고, 해당 버전의 문서를 참조한다
- **출처·신뢰도 명시** — 공식 문서, 웹 검색, 학습 데이터 중 어디서 온 정보인지 구분하고, 불확실할 때 명시적으로 밝힌다
- **llms.txt** — 문서 사이트에 LLM 친화적 진입점을 제공하는 표준. 자체 서비스 문서에도 적용 권장

## 관측 체계 (Execution Plane)
에이전트가 개발·운영에 참여하면 관측 범위가 확장된다.

### 계층 구조
1. **계측(Instrumentation)** — OpenTelemetry GenAI 시맨틱 규약으로 에이전트 행위를 표준화하여 기록
2. **에이전트 관측** — 추론 과정, 도구 호출, 의사결정 경로를 추적. 실패 시 단계별 재현 가능
3. **서비스 관측** — 에이전트가 만든/수정한 서비스의 에러·성능·이상 탐지. 에이전트 결정과 서비스 상태를 연결(correlation)
4. **비용 관측** — 토큰 사용량, API 호출 비용을 세션·태스크·모델별로 추적
5. **피드백 루프** — 프로덕션 오류 → 평가 데이터셋 → 에이전트 개선 → 재배포. 가드레일은 사후에도 추가

### 핵심 원칙
- 행위뿐 아니라 **추론 과정(why)**도 기록한다
- 에이전트 추적과 서비스 메트릭을 **상관 분석**할 수 있어야 한다
- 모든 관측 데이터는 **개방 표준(OpenTelemetry)**으로 수집하여 도구 종속을 피한다

### 구현 가이드라인
서비스를 개발할 때 모니터링·디버깅 시스템을 함께 구축한다. 서비스 코드와 관측 코드는 동시에 작성한다.

1. **계측 우선** — 새 기능을 만들 때 OpenTelemetry 트레이스/스팬을 함께 심는다. 나중에 붙이는 것이 아니라 코드의 일부로 취급한다
2. **에이전트 트레이싱** — Langfuse, LangSmith 등으로 에이전트의 추론·도구 호출 체인을 기록한다. 에이전트 실행 결과를 재현할 수 있어야 디버깅이 가능하다
3. **서비스 대시보드** — 에러율, 지연시간(P50/P99), 비용을 실시간으로 볼 수 있는 대시보드를 서비스 출시 전에 준비한다
4. **비용 게이트웨이** — LiteLLM, Helicone 등 AI 게이트웨이를 두어 토큰 사용량과 비용을 중앙에서 추적·제한한다
5. **알림 체계** — 임계값 초과 시 자동 알림. 이상 탐지는 고정 임계값보다 패턴 기반을 우선한다

## 핵심 데이터 모델
- **Run** — 실행 1회 (자율성, 상태, 비용)
- **Step** — 실행 단계 로그 (추론 과정 포함)
- **Artifact** — 결과물 (부분 재생성 가능)
- **Evidence** — 근거 (출처, 신뢰도, 공급 경로)

## 웹 도메인 적용
리소스(명사) 중심 영역에서 아래 계약을 지키면 자연스럽게 RESTful이 성립한다.
워크플로(동사) 중심 영역은 위의 Run/Job 데이터 모델을 따른다.

### 계약 (지켜야 할 것)
1. **주소·복원 계약** — URL = 상태 식별자. 새로고침/공유/딥링크/새 탭에서 동일 상태 재현
2. **히스토리 계약** — 뒤로가기/앞으로가기가 앱 상태 전이와 일치. push/replace 정책 명확
3. **HTTP 의미론** — GET은 조회, 나머지는 변경. 캐시/멱등성/재시도가 메서드 의미와 일치
4. **상태 경계** — 공유 상태는 URL/서버에, 일시적 UI 상태는 로컬에
5. **에러·로딩 계약** — 라우트별 에러/로딩 상태가 명시적으로 처리됨

### 검증 (지켜지는지 확인)
6. **관측 지표** — 에러율, 복구 실패율, 이탈률 수집/추적
7. **반패턴 신호** — 주소 불변+컨텍스트 변경, 직접 URL 깨짐, 뒤로가기 초기화
